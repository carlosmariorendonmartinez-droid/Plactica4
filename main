#include <iostream>  // Incluye la librería estándar para entrada/salida
#include <fstream>   // Permite leer y escribir archivos
#include <string>    // Habilita el uso del tipo string
#include "red.h"    // Incluye la definición de la clase Red
using namespace std; // Para evitar escribir std:: en cada uso

// Limpia el estado de cin cuando hay errores de entrada
void limpiarEntrada() {
    cin.clear();                 // Limpia flags de error
    cin.ignore(10000, '\n');    // Descarta el buffer restante
}

// Muestra el contenido de un archivo línea por línea
void mostrarArchivoEnConsola(const string &ruta) {
    ifstream in(ruta);           // Abre el archivo en modo lectura
    if (!in.is_open()) {         // Verifica si se abrió correctamente
        cout << "❌ No se pudo abrir el archivo para mostrar su contenido: " << ruta << "\n";
        return;
    }
    cout << "\n--- Contenido de " << ruta << " ---\n";
    string linea;
    int lineaNum = 1;

    // Lee el archivo completo línea por línea
    while (getline(in, linea)) {
        cout << lineaNum++ << ": " << linea << "\n";  // Imprime número de línea + contenido
    }
    cout << "--- Fin de " << ruta << " ---\n\n";
    in.close(); // Cierra el archivo
}

// Añade extensión ".txt" si el usuario no la coloca
string asegurarExtensionTxt(const string &nombre) {
    if (nombre.find('.') == string::npos)
        return nombre + ".txt";   // Si no tiene punto, agrega extensión
    return nombre;                 // Si ya tiene, lo deja igual
}

int main() {
    Red* red = new Red();  // Crea una red vacía
    int opcion = -1;       // Control del menú

    while (true) {         // Ciclo principal del programa
        cout << "\n========= MENU =========\n";
        cout << "1. Generar red aleatoria\n";
        cout << "2. Mostrar matriz de costos\n";
        cout << "3. Mostrar tablas de enrutamiento\n";
        cout << "4. Agregar enrutador\n";
        cout << "5. Eliminar enrutador\n";
        cout << "6. Agregar enlace\n";
        cout << "7. Eliminar enlace\n";
        cout << "8. Cargar red desde archivo\n";
        cout << "9. Guardar red en archivo\n";
        cout << "10. Calcular ruta mas corta\n";
        cout << "0. Salir\n";
        cout << "Elige: ";

        cin >> opcion;         // Lee opción elegida

        if (!cin) {            // Si entrada inválida
            limpiarEntrada();  // Limpia cin
            cout << "❌ Entrada inválida.\n";
            continue;
        }

        if (opcion == 0) {     // Condición de salida
            cout << "Saliendo...\n";
            break;
        }

        switch (opcion) {

        case 1: {  // GENERAR RED ALEATORIA
            int n;
            cout << "Cantidad de enrutadores: ";
            cin >> n;
            if (!cin || n <= 0) {    // Validación
                limpiarEntrada();
                cout << "❌ Número inválido.\n";
                break;
            }
            delete red;              // Elimina red anterior
            red = new Red(n);        // Crea red con n routers
            red->generarRedAleatoria();      // Genera enlaces con costos aleatorios
            red->actualizarTodasLasTablas(); // Calcula tablas de enrutamiento
            cout << "✔ Red aleatoria generada.\n";
            break;
        }

        case 2:
            red->mostrarRed();   // Imprime matriz de costos
            break;

        case 3:
            red->mostrarTablasDeEnrutamiento(); // Muestra las tablas de todos los routers
            break;

        case 4:
            red->agregarEnrutador();           // Agrega router al final
            red->actualizarTodasLasTablas();   // Recalcula rutas
            break;

        case 5: {  // ELIMINAR ENRUTADOR
            int id;
            cout << "ID a eliminar: ";
            cin >> id;
            if (!cin) {
                limpiarEntrada();
                cout << "❌ Entrada inválida.\n";
                break;
            }
            red->eliminarEnrutador(id);        // Borra router
            red->actualizarTodasLasTablas();   // Recalcula rutas
            break;
        }

        case 6: {  // AGREGAR ENLACE
            int id1, id2, costo;
            cout << "Ingresa id1 id2 costo: ";
            if (!(cin >> id1 >> id2 >> costo)) {
                limpiarEntrada();
                cout << "❌ Entrada inválida. Se requieren 3 números.\n";
                break;
            }
            red->agregarEnlaceSeguro(id1, id2, costo); // Crea enlace entre routers
            red->actualizarTodasLasTablas();
            break;
        }

        case 7: {  // ELIMINAR ENLACE
            int id1, id2;
            cout << "Ingresa id1 id2: ";
            if (!(cin >> id1 >> id2)) {
                limpiarEntrada();
                cout << "❌ Entrada inválida. Se requieren 2 números.\n";
                break;
            }
            red->eliminarEnlaceSeguro(id1, id2); // Quita conexión
            red->actualizarTodasLasTablas();
            break;
        }

        case 8: {  // CARGAR DESDE ARCHIVO
            string archivo;
            cout << "Archivo: ";
            cin >> archivo;
            archivo = asegurarExtensionTxt(archivo);

            if (red->cargarDesdeArchivo(archivo)) {
                red->actualizarTodasLasTablas();
                cout << "✔ Archivo cargado correctamente.\n";
            } else {
                cout << "❌ No se pudo cargar la red.\n";
            }
            break;
        }

        case 9: {  // GUARDAR EN ARCHIVO
            string archivo;
            cout << "Archivo: ";
            cin >> archivo;
            archivo = asegurarExtensionTxt(archivo);

            if (red->guardarEnArchivo(archivo)) {
                cout << "✔ Archivo guardado correctamente: " << archivo << "\n";
                mostrarArchivoEnConsola(archivo); // Muestra lo guardado
            } else {
                cout << "❌ No se pudo guardar.\n";
            }
            break;
        }

        case 10: { // CALCULAR RUTA MÁS CORTA
            int o, d;
            cout << "Origen y destino: ";
            if (!(cin >> o >> d)) {
                limpiarEntrada();
                cout << "❌ Entrada inválida.\n";
                break;
            }
            red->calcularRutaMasCorta(o, d);
            break;
        }

        default:
            cout << "❌ Opción inválida.\n";
        }
    }

    delete red; // Libera memoria al salir
    return 0;   // Fin del programa
}
